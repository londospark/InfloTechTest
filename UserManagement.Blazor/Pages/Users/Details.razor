@page "/users/{id:long}"
@inject Services.IUsersClient UsersClient
@inject NavigationManager Nav
@using UserManagement.Blazor.Components
@using System.Globalization
@using System.Linq
@using UserManagement.Shared.DTOs

<PageTitle>User Details</PageTitle>

<h3>User Details</h3>

@if (loading)
{
    <p>Loading...</p>
}
else if (!string.IsNullOrEmpty(error))
{
    <div class="alert alert-danger" role="alert">@error</div>
}
else if (user is not null)
{
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-3">Id</dt>
                        <dd class="col-sm-9" data-testid="user-id">@user.Id</dd>

                        <dt class="col-sm-3">Forename</dt>
                        <dd class="col-sm-9" data-testid="user-forename">
                            <EditSwitch IsEditing="isEditing">
                                <Display>
                                    @user.Forename
                                </Display>
                                <Edit>
                                    <InputText id="forename" class="form-control" @bind-Value="editModel.Forename" />
                                </Edit>
                            </EditSwitch>
                        </dd>

                        <dt class="col-sm-3">Surname</dt>
                        <dd class="col-sm-9" data-testid="user-surname">
                            <EditSwitch IsEditing="isEditing">
                                <Display>
                                    @user.Surname
                                </Display>
                                <Edit>
                                    <InputText id="surname" class="form-control" @bind-Value="editModel.Surname" />
                                </Edit>
                            </EditSwitch>
                        </dd>

                        <dt class="col-sm-3">Email</dt>
                        <dd class="col-sm-9" data-testid="user-email">
                            <EditSwitch IsEditing="isEditing">
                                <Display>
                                    @user.Email
                                </Display>
                                <Edit>
                                    <InputText id="email" type="email" class="form-control" @bind-Value="editModel.Email" />
                                </Edit>
                            </EditSwitch>
                        </dd>

                        <dt class="col-sm-3">Date of Birth</dt>
                        <dd class="col-sm-9" data-testid="user-dob">
                            <EditSwitch IsEditing="isEditing">
                                <Display>
                                    @user.DateOfBirth.ToString("d", CultureInfo.CurrentCulture)
                                </Display>
                                <Edit>
                                    <InputDate id="dob" class="form-control" @bind-Value="editModel.DateOfBirth" />
                                </Edit>
                            </EditSwitch>
                        </dd>

                        <dt class="col-sm-3">Active</dt>
                        <dd class="col-sm-9" data-testid="user-active">
                            <EditSwitch IsEditing="isEditing">
                                <Display>
                                    @(user.IsActive ? "Yes" : "No")
                                </Display>
                                <Edit>
                                    <div class="form-check mb-0">
                                        <InputCheckbox id="isActive" class="form-check-input" @bind-Value="editModel.IsActive" />
                                        <label class="form-check-label" for="isActive">Active</label>
                                    </div>
                                </Edit>
                            </EditSwitch>
                        </dd>
                    </dl>

                    <div class="d-flex gap-2">
                        @if (!isEditing)
                        {
                            <button class="btn btn-primary" data-testid="edit-user" @onclick="StartEdit">Edit</button>
                            <a href="/users" class="btn btn-secondary">Back to list</a>
                        }
                        else
                        {
                            <button class="btn btn-primary" data-testid="save-user" @onclick="SaveEdit">Save</button>
                            <button type="button" class="btn btn-secondary" data-testid="cancel-edit" @onclick="CancelEdit">Cancel</button>
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5>Activity Logs</h5>

                    @if (logsLoading)
                    {
                        <p>Loading logs...</p>
                    }
                    else if (logs is null || !logs.Items.Any())
                    {
                        <p>No logs found.</p>
                    }
                    else
                    {
                        <ul class="list-group mb-2">
                            @foreach (var l in logs.Items)
                            {
                                <li class="list-group-item">
                                    <div><strong>@l.CreatedAt.ToString("g")</strong></div>
                                    <div>@l.Message</div>
                                </li>
                            }
                        </ul>

                        <nav>
                            <ul class="pagination">
                                <li class="page-item @(logPage <= 1 ? "disabled" : "")">
                                    <a class="page-link" href="#" @onclick="@(async e => await ChangeLogPage(logPage - 1))" @onclick:preventDefault="true">Previous</a>
                                </li>
                                <li class="page-item disabled"><span class="page-link">Page @logPage</span></li>
                                <li class="page-item @(logs.HasMore ? "" : "disabled")">
                                    <a class="page-link" href="#" @onclick="@(async e => await ChangeLogPage(logPage + 1))" @onclick:preventDefault="true">Next</a>
                                </li>
                            </ul>
                        </nav>
                    }
                </div>
            </div>
        </div>
    </div>
}
else
{
    <p>Not found.</p>
}

@code {
    [Parameter]
    public long id { get; set; }

    [SupplyParameterFromQuery]
    public bool? edit { get; set; }

    [SupplyParameterFromQuery(Name = "return")]
    public string? returnUrl { get; set; }

    private bool loading = true;
    private string? error;
    private Shared.DTOs.UserListItemDto? user;
    private bool isEditing;
    private EditUserModel editModel = new();

    private bool logsLoading;
    private PagedResultDto<Shared.DTOs.UserLogDto>? logs;
    private int logPage = 1;
    private int logPageSize = 5;

    private bool HasMoreLogs => logs is not null && logs.HasMore;

    protected override async Task OnParametersSetAsync()
    {
        await LoadAsync();
        if (edit is true && !isEditing)
        {
            StartEdit();
        }
    }

    private async Task LoadAsync()
    {
        loading = true;
        error = null;
        user = null;
        logs = null;
        logsLoading = true;
        try
        {
            user = await UsersClient.GetUserAsync(id);
            // Load first page of logs after user is retrieved
            await LoadLogsAsync();
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            loading = false;
            logsLoading = false;
        }
    }

    private async Task LoadLogsAsync()
    {
        logsLoading = true;
        logs = null;
        try
        {
            logs = await UsersClient.GetUserLogsAsync(id, logPage, logPageSize);
        }
        catch (Exception)
        {
            // ignore log errors for now, show empty
            logs = new PagedResultDto<Shared.DTOs.UserLogDto>(Array.Empty<Shared.DTOs.UserLogDto>().ToList(), logPage, logPageSize, 0);
        }
        finally
        {
            logsLoading = false;
        }
    }

    private async Task ChangeLogPage(int newPage)
    {
        if (newPage < 1) return;
        // If trying to go forward but there are no more logs, don't change page
        if (newPage > logPage && !HasMoreLogs) return;
        logPage = newPage;
        await LoadLogsAsync();
    }

    private void StartEdit()
    {
        if (user is null) return;
        editModel = new()
        {
            Forename = user.Forename ?? string.Empty,
            Surname = user.Surname ?? string.Empty,
            Email = user.Email ?? string.Empty,
            DateOfBirth = user.DateOfBirth,
            IsActive = user.IsActive
        };
        isEditing = true;
    }

    private void CancelEdit()
    {
        if (TryNavigateBack())
        {
            return;
        }
        isEditing = false;
    }

    private async Task SaveEdit()
    {
        if (user is not null)
        {
            var request = new Shared.DTOs.CreateUserRequestDto
            {
                Forename = editModel.Forename,
                Surname = editModel.Surname,
                Email = editModel.Email,
                DateOfBirth = editModel.DateOfBirth,
                IsActive = editModel.IsActive
            };

            try
            {
                var updated = await UsersClient.UpdateUserAsync(user.Id, request);
                user = updated;
                if (TryNavigateBack())
                {
                    return;
                }
            }
            catch
            {
                // If the update fails, keep editing mode so the user can retry or cancel
                return;
            }
        }
        isEditing = false;
    }

    private bool TryNavigateBack()
    {
        // Only allow local, relative paths to avoid open redirects
        if (!string.IsNullOrWhiteSpace(returnUrl)
            && returnUrl!.StartsWith("/", StringComparison.Ordinal)
            && !returnUrl.Contains("://", StringComparison.Ordinal))
        {
            Nav.NavigateTo(returnUrl!, replace: true);
            return true;
        }
        return false;
    }

    private sealed class EditUserModel
    {
        public string Forename { get; set; } = string.Empty;
        public string Surname { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public DateTime DateOfBirth { get; set; } = DateTime.Today;
        public bool IsActive { get; set; }
    }
}
