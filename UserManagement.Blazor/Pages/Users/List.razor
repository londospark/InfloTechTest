@page "/users"
@inject Services.IUsersClient UsersClient
@using UserManagement.Blazor.Components

<PageTitle>Users</PageTitle>

<h1>Users</h1>

<div class="mb-3">
    <a class="btn btn-success me-3" href="/users/add">Add User</a>
    <label for="userFilter" class="form-label">Filter</label>
    <select id="userFilter" class="form-select" @onchange="OnFilterChanged" value="@selectedFilter">
        <option value="All">All users</option>
        <option value="Active">Active users</option>
        <option value="Inactive">Inactive users</option>
    </select>
</div>

@if (loading)
{
    <p>Loading...</p>
}
else if (!string.IsNullOrEmpty(error))
{
    <div class="alert alert-danger" role="alert">@error</div>
}
else if (users?.Items?.Count > 0)
{
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
            <tr>
                <th>Id</th>
                <th>Forename</th>
                <th>Surname</th>
                <th>Email</th>
                <th>Date of Birth</th>
                <th>Active</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            @foreach (var u in users.Items)
            {
                <tr>
                    <td>@u.Id</td>
                    <td>@u.Forename</td>
                    <td>@u.Surname</td>
                    <td>@u.Email</td>
                    <td>@u.DateOfBirth.ToString("yyyy-MM-dd")</td>
                    <td>
                        @if (u.IsActive)
                        {
                            <span class="badge bg-success">Yes</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">No</span>
                        }
                    </td>
                    <td>
                        <button class="btn btn-sm btn-danger" data-testid="@($"delete-{u.Id}")" @onclick="() => OnDeleteClicked(u.Id)">Delete</button>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>
}
else
{
    <p>No users found.</p>
}

@code {
    private bool loading = true;
    private string? error;
    private Shared.DTOs.UserListDto? users;
    private string selectedFilter = "All";

    protected override async Task OnInitializedAsync()
    {
        await LoadUsersAsync();
    }

    private async Task OnFilterChanged(ChangeEventArgs e)
    {
        selectedFilter = e.Value?.ToString() ?? "All";
        await LoadUsersAsync();
    }

    private async Task LoadUsersAsync()
    {
        loading = true;
        error = null;
        try
        {
            users = selectedFilter switch
            {
                "Active" => await UsersClient.GetUsersByActiveAsync(true),
                "Inactive" => await UsersClient.GetUsersByActiveAsync(false),
                _ => await UsersClient.GetUsersAsync()
            };
        }
        catch (Exception ex)
        {
            error = ex.Message;
            users = new([]);
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }

    private bool showConfirm;
    private long? pendingDeleteId;

    private void OnDeleteClicked(long id)
    {
        pendingDeleteId = id;
        showConfirm = true;
    }

    private async Task ConfirmDeleteAsync()
    {
        if (pendingDeleteId is null)
        {
            showConfirm = false;
            return;
        }

        try
        {
            await UsersClient.DeleteUserAsync(pendingDeleteId.Value);
            showConfirm = false;
            pendingDeleteId = null;
            await LoadUsersAsync();
        }
        catch (Exception ex)
        {
            error = ex.Message;
            showConfirm = false;
            pendingDeleteId = null;
        }
    }

    private void CancelDelete()
    {
        showConfirm = false;
        pendingDeleteId = null;
    }
}

<ConfirmDialog
    Show="@showConfirm"
    Title="Confirm deletion"
    Message="Are you sure you want to delete this user?"
    ConfirmText="Delete"
    CancelText="Cancel"
    ConfirmTestId="confirm-delete"
    CancelTestId="cancel-delete"
    OnConfirm="ConfirmDeleteAsync"
    OnCancel="CancelDelete" />
